#+TITLE: My GNU Emacs config
#+AUTHOR: daym0ns
#+DESCRIPTION: Emacs config
#+STARTUP: showeverything
#+OPTIONS: toc:2

* TABLE OF CONTENTS :toc:
- [[#1-the-basics][1. The Basics]]
  - [[#sane-defaults][Sane defaults]]
  - [[#straightel-package-manager][Straight.el Package manager]]
  - [[#evil-mode-vim-motions-and-related-options][Evil Mode (vim motions) and related options]]
  - [[#basic-completions-for-minibuffer---not-lsp-completions][Basic completions for minibuffer - NOT lsp completions]]
- [[#2-gui-tweaks][2. GUI Tweaks]]
  - [[#fonts][Fonts]]
  - [[#themes][Themes]]
  - [[#rainbow-mode][Rainbow mode]]
  - [[#icons][Icons]]
  - [[#modeline][Modeline]]
- [[#3-advanced-configuration][3. Advanced configuration]]
  - [[#telescope-like-search][Telescope-like search]]
  - [[#terminal-emulators][Terminal emulators]]
  - [[#lsp][LSP]]
  - [[#completion][Completion]]
- [[#4-org-mode][4. Org mode]]
  - [[#basic-settings][Basic settings]]
  - [[#automatic-toc-generation][Automatic ToC generation]]
  - [[#nicer-symbols][Nicer symbols]]
  - [[#font-ligatures][Font Ligatures]]
- [[#5-keybindings][5. Keybindings]]
  - [[#custom-commands][Custom commands]]
  - [[#leader-key-keymaps][Leader key keymaps]]
  - [[#other-keymaps][Other keymaps]]

* 1. The Basics

** Sane defaults
#+BEGIN_SRC emacs-lisp :tangle yes

  ;; Disable useless UI elements
  (menu-bar-mode -1)
  (tool-bar-mode -1)
  (scroll-bar-mode -1)

  ;; Dired doesnt use ls
  (setq dired-use-ls-dired nil)

  ;; Tab settings
  (setq-default tab-width 2)
  (setq-default indent-tabs-mode nil)
  (global-set-key (kbd "TAB") #'self-insert-command)

  ;; Y/n instead of Yes/No
  (fset 'yes-or-no-p 'y-or-n-p)

  ;; No splash screen
  (setq inhibit-startup-screen t)

  ;; Backup settings
  (setq backup-directory-alist `(("." . ,(expand-file-name "cache/backups/" user-emacs-directory)))
  	    auto-save-default nil)

  ;; Scroll margins
  (setq scroll-conservatively 101
        scroll-margin 12)

  ;; Make esc quit cmdline
  (defun my/minibuffer-escape ()
  (interactive)
  (if (minibufferp)
      (abort-recursive-edit)
    (keyboard-quit)))

  (global-set-key (kbd "<escape>") 'my/minibuffer-escape)

#+END_SRC

** Straight.el Package manager
#+BEGIN_SRC emacs-lisp :tangle yes
  (defvar bootstrap-version)
  (let ((bootstrap-file
         (expand-file-name
          "straight/repos/straight.el/bootstrap.el"
          (or (bound-and-true-p straight-base-dir)
              user-emacs-directory)))
        (bootstrap-version 7))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
          (url-retrieve-synchronously
           "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
           'silent 'inhibit-cookies)
        (goto-char (point-max))
        (eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))
  (setq straight-use-package-by-default t)
  (straight-use-package 'org)
  (straight-use-package 'use-package)
#+END_SRC

** Evil Mode (vim motions) and related options
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package general)

  ;; Persistent undo
  (use-package undo-fu)
  (use-package undo-fu-session
    :init
    (setq undo-fu-session-directory (expand-file-name "cache/undo/" user-emacs-directory))
    :config
    (undo-fu-session-global-mode))


  (use-package evil
    :init
    (setq evil-want-integration t
          evil-want-keybinding nil
          evil-want-C-u-scroll t
          evil-shift-width 2
          evil-undo-system 'undo-fu)
    :config
    (evil-mode 1))

  (use-package evil-collection
    :after evil
    :config
    (evil-collection-init))

  (use-package evil-surround
    :after evil
    :config
    (global-evil-surround-mode 1))

  (use-package evil-commentary
    :config
    (evil-commentary-mode t))

  ;; Line numbers and line highlight
  (global-display-line-numbers-mode t)
  (global-hl-line-mode t)
#+END_SRC

** Basic completions for minibuffer - NOT lsp completions
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package vertico
    :init
    (vertico-mode 1)
    (setq vertico-cycle t))

  (use-package orderless
    :init
    (setq completion-styles '(orderless basic)
          completion-category-defaults nil
          completion-category-overrides
          '((file (styles basic partial-completion)))))

  (use-package marginalia
    :init
    (marginalia-mode 1))

  (use-package savehist
    :init
    (savehist-mode 1))

  (setq completion-ignore-case t
        read-file-name-completion-ignore-case t
        read-buffer-completion-ignore-case t
        enable-recursive-minibuffers t)

  (minibuffer-depth-indicate-mode 1)

#+END_SRC



* 2. GUI Tweaks

** Fonts
#+BEGIN_SRC emacs-lisp :tangle yes
  ;; Font
  (set-face-attribute 'default nil
    		              :family "CaskaydiaCove Nerd Font"
    		              :height 260)

#+END_SRC

** Themes
#+BEGIN_SRC emacs-lisp :tangle yes

  (use-package catppuccin-theme)
  (use-package doom-themes
    :ensure t
    :custom
    (doom-themes-enable-bold t)
    (doom-themes-enable-italic t)
    (doom-themes-treemacs-theme "doom-atom")
    :config
    ;; Enable custom neotree theme (nerd-icons must be installed!)
    (doom-themes-neotree-config)
    ;; or for treemacs users
    (doom-themes-treemacs-config)
    ;; Corrects (and improves) org-mode's native fontification.
    (doom-themes-org-config))

  (load-theme 'doom-one t)

#+END_SRC

** Rainbow mode
#+BEGIN_SRC emacs-lisp :tangle yes
(use-package rainbow-mode
  :hook 
  ((org-mode prog-mode) . rainbow-mode))
#+END_SRC

** Icons
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package nerd-icons)

  (use-package nerd-icons-dired
    :hook
    (dired-mode . nerd-icons-dired-mode))

  (use-package nerd-icons-completion
    :config
    (nerd-icons-completion-mode))

  (use-package nerd-icons-ibuffer
    :hook (ibuffer-mode . nerd-icons-ibuffer-mode))
#+END_SRC

** Modeline
#+BEGIN_SRC emacs-lisp :tangle yes

  (use-package doom-modeline
    :after evil
    :ensure t
    :init (doom-modeline-mode 1))

#+END_SRC



* 3. Advanced configuration

** Telescope-like search
#+BEGIN_SRC emacs-lisp :tangle yes
    (use-package projectile
      :init
      (projectile-mode +1)
      (setq projectile-project-search-path '("~/Projects/" "~/dotfiles")))

    (use-package rg
      :commands (rg rg-project))

    (use-package consult
      :after vertico
      :init
      (setq consult-preview-key 'any)
      (recentf-mode))
#+END_SRC

** Terminal emulators
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package vterm
    :config
    (setq shell-file-name "/usr/bin/env zsh"
          vterm-max-scrollback 5000))

  (use-package vterm-toggle
    :after vterm
    :config
    (setq vterm-toggle-fullscreen-p nil)
    (add-to-list 'display-buffer-alist
                 '((lambda (buffer-or-name _)
                     (let ((buffer (get-buffer buffer-or-name)))
                       (with-current-buffer buffer
                         (or (equal major-mode 'vterm-mode)
                             (string-prefix-p vterm-buffer-name (buffer-name buffer))))))
                   (display-buffer-reuse-window display-buffer-same-window))))


#+END_SRC

** LSP
#+BEGIN_SRC emacs-lisp :tangle yes

    (use-package mason
      :ensure t
      :config
      (mason-setup))

    (use-package lsp-mode
      :ensure t
      :commands (lsp lsp-deferred)
      :init
      (setq lsp-keymap-prefix "C-c l") ; optional but recommended
      :hook
      (go-mode . lsp)
      :config
      (setq lsp-enable-snippet t
            lsp-prefer-capf t))

    (use-package lsp-ui
      :ensure t
      :after lsp-mode
      :hook (lsp-mode . lsp-ui-mode)
      :config
      (setq lsp-ui-doc-position 'bottom
            lsp-ui-doc-delay 0.3))

    (use-package lua-mode
      :ensure t
      :config
      (setq lsp-lua-language-server-command "lua-language-server")
      :hook (lua-mode . lsp))

    (use-package consult-lsp
      :ensure t
      :after (consult lsp-mode))

#+END_SRC

** Completion
#+BEGIN_SRC emacs-lisp :tangle yes

  (use-package corfu
    :ensure t
    :init
    (global-corfu-mode)
    :config
    (setq corfu-auto t
          corfu-cycle t))
#+END_SRC


* 4. Org mode

** Basic settings
#+BEGIN_SRC emacs-lisp :tangle yes

  ;; Make TODO list percentage work
  (setq org-checkbox-hierarchical-statistics t)

  ;; Set heading sizes
  (dolist (face '((org-level-1 . 1.2)
                  (org-level-2 . 1.1)
                  (org-level-3 . 1.05)
                  (org-level-4 . 1.0)
                  (org-level-5 . 1.0)
                  (org-level-6 . 1.0)
                  (org-level-7 . 1.0)
                  (org-level-8 . 1.0)))
    (set-face-attribute (car face) nil :height (cdr face)))



#+END_SRC

** Automatic ToC generation
#+BEGIN_SRC emacs-lisp :tangle yes

  (use-package toc-org
    :hook (org-mode . toc-org-mode))

#+END_SRC

** Nicer symbols
   #+BEGIN_SRC emacs-lisp :tangle yes

     ;; stolen from sophiebos.io :)
     (use-package org-superstar
       :config
       (setq org-superstar-leading-bullet " ")
       (setq org-superstar-headline-bullets-list '("◉" "○" "⚬" "◈" "◇"))
       :hook (org-mode . org-superstar-mode))

     (defun my/prettify-symbols-setup ()
       (push '("#+BEGIN_SRC" . ?≫) prettify-symbols-alist)
       (push '("#+END_SRC" . ?≫) prettify-symbols-alist)
       (push '("#+begin_src" . ?≫) prettify-symbols-alist)
       (push '("#+end_src" . ?≫) prettify-symbols-alist)

       ;; Tags
       (push '(":projects:" . "") prettify-symbols-alist)
       (push '(":work:"     . "") prettify-symbols-alist)
       (push '(":inbox:"    . "") prettify-symbols-alist)
       (push '(":task:"     . "") prettify-symbols-alist)
       (push '(":thesis:"   . "") prettify-symbols-alist)
       (push '(":uio:"      . "") prettify-symbols-alist)
       (push '(":emacs:"    . "") prettify-symbols-alist)
       (push '(":learn:"    . "") prettify-symbols-alist)
       (push '(":code:"     . "") prettify-symbols-alist)
       (push '(":toc:"      . "󰠶") prettify-symbols-alist)

       (prettify-symbols-mode))

     (add-hook 'org-mode-hook        #'my/prettify-symbols-setup)
     (add-hook 'org-agenda-mode-hook #'my/prettify-symbols-setup)

   #+END_SRC

** Font Ligatures
  #+BEGIN_SRC emacs-lisp :tangle yes

    (use-package ligature
      :config
      (ligature-set-ligatures 'org-mode
       '("|||>" "<|||" "<==>" "<!--" "####" "~~>" "***" "||=" "||>"
         ":::" "::=" "=:=" "===" "==>" "=!=" "=>>" "=<<" "=/=" "!=="
         "!!." ">=>" ">>=" ">>>" ">>-" ">->" "->>" "-->" "---" "-<<"
         "<~~" "<~>" "<*>" "<||" "<|>" "<$>" "<==" "<=>" "<=<" "<->"
         "<--" "<-<" "<<=" "<<-" "<<<" "<+>" "</>" "###" "#_(" "..<"
         "~>" "~-" "**" "*>" "*/" "||" "|}" "|]" "|=" "|>" "|-" "{|"
         "[|" "]#" "::" ":=" ":>" ":<" "$>" "==" "=>" "!=" "!!" ">:"
         ">=" ">>" ">-" "-~" "-|" "->" "--" "-<" "<~" "<*" "<|" "<:"
         "<$" "<=" "<>" "<-" "<<" "<+" "</" "#{" "#[" "#:" "#=" "#!"
         "##" "#(" "#?" "#_" "%%" ".=" ".-" ".." ".?" "+>" "++" "?:"
         "?=" "?." "??" ";;" "/*" "/=" "/>" "//" "__" "~~" "(*" "*)"
         "..." "+++" "/==" "///" "_|_" "&&" "^=" "~~" "~@" "~="
         "\\\\" "://"))
      :hook (org-mode . ligature-mode))

  #+END_SRC


* 5. Keybindings

** Custom commands
#+BEGIN_SRC emacs-lisp :tangle yes

  ;; Enable which-key
  (which-key-mode t)
  (setq which-key-idle-delay 0.1)

  (defun my/rg-any-dir ()
    "Run rg in the chosen directory."
    (interactive)
    (let ((dir (read-directory-name "rg: ")))
      (consult-ripgrep dir)))

  (defun my/rg-cwd ()
    "Run rg in the current working directory."
    (interactive)
    (let ((default-directory (or (projectile-project-root) default-directory)))
      (consult-ripgrep default-directory)))

  (defun my/explore-config ()
    "Explore the users private config files with dired."
    (interactive)
    (dired user-emacs-directory))

  (defun my/tab-spaces ()
    "Insert x spaces when TAB is pressed."
    (interactive)
    (insert "  ")) ;; Change the number of spaces here

  (defun reload-init-file ()
    (interactive)
    (load-file user-init-file)
    (load-file user-init-file))

#+END_SRC


** Leader key keymaps
#+BEGIN_SRC emacs-lisp :tangle yes

  ;; Set the leader key
  (general-create-definer my/leader
    :states '(normal visual emacs)
    :keymaps 'override
    :prefix "SPC"
    :global-prefix "C-SPC")

  ;; Set keymaps with leader key
  (my/leader
    "." '(dired-jump :wk "Open Dired"))

  (my/leader
    "ca" '(lsp-execute-code-action :wk "Code Actions")
    "rn" '(lsp-rename :wk "LSP Rename")
  )

  (my/leader
    "w" '(:ignore t :wk "Windows")
    "wc" '(evil-window-delete :wk "Close window")
    "wn" '(evil-window-new :wk "New window")
    "ws" '(evil-window-split :wk "New window split")
    "wv" '(evil-window-vsplit :wk "New window vsplit")
    "wh" '(evil-window-left :wk "Move focus left")
    "wj" '(evil-window-down :wk "Move focus down")
    "wk" '(evil-window-up :wk "Move focus up")
    "wl" '(evil-window-right :wk "Move focus right")
    "ww" '(evil-window-next :wk "Move focus next")
    )

  (my/leader
    "b" '(:ignore t :wk "Buffers")
    "bd" '(kill-buffer :wk "Delete buffer")
    "bn" '(next-buffer :wk "Next buffer")
    "bp" '(previous-buffer :wk "Next buffer")
    )

  (my/leader
    "e" '(:ignore t :wk "Evaluate")
    "eb" '(eval-buffer :wk "Evaluate buffer")
    "ed" '(eval-defun :wk "Evaluate defun")
    "er" '(eval-region :wk "Evaluate region")
    "ee" '(eval-expression :wk "Evaluate expression")
    "el" '(eval-last-sexp :wk "Evaluate last expression")
    )

  (my/leader   
    "f" '(:ignore t :wk "Find")
    "fr" '(consult-recent-file :wk "Find recent files")
    "ff" '(find-file :wk "Find files")
    "fb" '(consult-buffer :wk "Find buffers")
    "fG" '(my/rg-any-dir :wk "Grep in directory")
    "fg" '(my/rg-cwd :wk "Live grep")
    "fP" '(my/explore-config :wk "Explore config")
    "fp" '(projectile-switch-project :wk "Find Projects")
    )

  (my/leader   
    "t" '(:ignore t :wk "Toggle")
    "tt" '(vterm-toggle :wk "Toggle terminal")
    )


  (my/leader
    "hrr" '(reload-init-file :wk "Reload emacs init file"))

#+END_SRC

** Other keymaps
#+BEGIN_SRC emacs-lisp :tangle yes

  ;; Other keymaps
  (define-key evil-insert-state-map (kbd "TAB") #'my/tab-spaces)
  (define-key vertico-map (kbd "C-j") 'vertico-next)
  (define-key vertico-map (kbd "C-k") 'vertico-previous)

  (with-eval-after-load 'lsp-mode
    (evil-define-key 'normal lsp-mode-map
      "gd" #'lsp-find-definition
      "gr" #'lsp-find-references
      "K"  #'lsp-hover
      "gi" #'lsp-find-implementation))



#+END_SRC
